# LiveKit Helm Chart Values for digi-telephony.com
# Production configuration matching your existing deployment

livekit:
  domain: livekit-tf.digi-telephony.com
  rtc:
    use_external_ip: true
    port_range_start: 50000
    port_range_end: 60000
  
  # Redis configuration - UPDATE WITH YOUR REDIS ENDPOINT
  redis:
    address: clustercfg.livekit-redis.x4ncn3.use1.cache.amazonaws.com:6379
  
  # API keys configuration
  keys:
    APIKmrHi78hxpbd: Y3vpZUiNQyC8DdQevWeIdzfMgmjs5hUycqJA22atniuB
  
  # Metrics configuration
  metrics:
    enabled: true
    prometheus:
      enabled: true
      port: 6789

# Resource configuration
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# Pod anti-affinity for better distribution
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
    - labelSelector:
        matchExpressions:
        - key: app
          operator: In
          values:
          - livekit-livekit-server
      topologyKey: "kubernetes.io/hostname"

# TURN server configuration
turn:
  enabled: true
  domain: turn-livekit-tf.digi-telephony.com
  tls_port: 3478
  udp_port: 3478
  # No secretName needed - using ALB certificate

# Load Balancer configuration for AWS ALB
loadBalancer:
  type: alb
  tls:
    - hosts:
        - livekit-tf.digi-telephony.com
      certificateArn: arn:aws:acm:us-east-1:918595516608:certificate/388e3ff7-9763-4772-bfef-56cf64fcc414

# Service configuration
service:
  type: ClusterIP

# Ingress configuration for ALB with your certificate
ingress:
  enabled: true
  className: alb
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80},{"HTTPS":443}]'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:918595516608:certificate/388e3ff7-9763-4772-bfef-56cf64fcc414
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/ssl-policy: ELBSecurityPolicy-TLS-1-2-2017-01
    # Health check configuration
    alb.ingress.kubernetes.io/healthcheck-path: /
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '3'
    
  hosts:
    - host: livekit-tf.digi-telephony.com
      paths:
        - path: /
          pathType: Prefix

# Autoscaling configuration
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 60

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# Service account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Node selector (optional)
nodeSelector: {}

# Tolerations (optional)
tolerations: []

# ✅ CONFIGURATION NOTES:
# - Domain: livekit-tf.digi-telephony.com
# - TURN Domain: turn-livekit-tf.digi-telephony.com
# - Certificate: ACM wildcard certificate for *.digi-telephony.com
# - Load Balancer: AWS ALB with automatic HTTPS redirect
# - No manual TLS secrets needed - using ACM certificate
# - Traffic flows: Internet → ALB → LiveKit Service → LiveKit Pods

# Node selector (optional - use for specific node types)
nodeSelector: {}

# Tolerations (optional - use for tainted nodes)
tolerations: []

# Affinity (optional - use for pod placement)
affinity: {}

# Additional environment variables (optional)
env: []

# Additional volumes (optional)
volumes: []

# Additional volume mounts (optional)
volumeMounts: []

# Security context (optional)
securityContext: {}

# Pod security context (optional)
podSecurityContext: {}

# Image pull secrets (optional)
imagePullSecrets: []

# Service account (optional)
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Pod annotations (optional)
podAnnotations: {}

# Pod labels (optional)
podLabels: {}

# ⚠️ IMPORTANT NOTES FOR WILDCARD CERTIFICATES ⚠️
#
# 1. ACM Certificate (Recommended):
#    - Import your wildcard certificate to AWS Certificate Manager
#    - Get the certificate ARN from ACM console
#    - Add the ARN to alb.ingress.kubernetes.io/certificate-arn annotation
#    - Enable SSL redirect: alb.ingress.kubernetes.io/ssl-redirect: '443'
#
# 2. Manual TLS Secret (Testing only):
#    - Create secret: kubectl create secret tls livekit-tls-secret --cert=wildcard.crt --key=wildcard.key -n livekit
#    - Uncomment secretName in turn and tls sections
#    - This approach has limitations with ALB
#
# 3. cert-manager (Automated):
#    - Install cert-manager in your cluster
#    - Configure ACME provider (Let's Encrypt)
#    - Add cert-manager annotations to ingress
#    - Note: Wildcard certs require DNS-01 challenge
#
# 4. No TLS (Development only):
#    - Remove/comment out all TLS configurations
#    - Use HTTP only (not recommended for production)
#
# For production with wildcard certificates, ACM is the recommended approach.