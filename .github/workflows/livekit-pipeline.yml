name: ğŸš€ LiveKit Pipeline (Manual)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - uat
          - prod

env:
  AWS_REGION: us-east-1

permissions:
  id-token: write
  contents: read

jobs:
  # Step 1: Prerequisites
  prerequisites:
    name: ğŸ”§ Step 1 - Prerequisites
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'deploy' }}
    environment: livekit-poc-${{ inputs.environment }}-prerequisites
    
    steps:
      - name: ğŸ“‹ Manual Approval - Prerequisites
        run: |
          echo "ğŸ¤” Manual approval required for prerequisites"
          echo "ğŸ“‹ This will verify:"
          echo "   - AWS credentials and permissions"
          echo "   - Required tools versions"
          echo "   - S3 backend accessibility"
          echo "   - Environment configuration"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "â±ï¸ Time: ~2-3 minutes"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: GitHubActions-Prerequisites-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Tools
        run: |
          # Setup Terraform
          wget -q https://releases.hashicorp.com/terraform/1.10.3/terraform_1.10.3_linux_amd64.zip
          unzip -q terraform_1.10.3_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          
          # Setup kubectl
          curl -LO "https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          
          # Setup Helm
          curl -fsSL https://get.helm.sh/helm-v3.16.3-linux-amd64.tar.gz | tar -xz
          sudo mv linux-amd64/helm /usr/local/bin/
          
          # Setup eksctl
          curl -sLO "https://github.com/eksctl-io/eksctl/releases/download/v0.191.0/eksctl_Linux_amd64.tar.gz"
          tar -xzf eksctl_Linux_amd64.tar.gz
          sudo mv eksctl /usr/local/bin/

      - name: Run Prerequisites Script
        working-directory: scripts
        run: |
          chmod +x 00-prerequisites.sh
          ./00-prerequisites.sh

  # Step 2: Terraform Plan
  terraform-plan:
    name: ğŸ“‹ Step 2 - Terraform Plan
    runs-on: ubuntu-latest
    needs: [prerequisites]
    if: ${{ inputs.action == 'deploy' }}
    environment: livekit-poc-${{ inputs.environment }}-terraform-plan
    outputs:
      plan-output: ${{ steps.plan.outputs.plan_output }}
    
    steps:
      - name: ğŸ“‹ Manual Approval - Terraform Plan
        run: |
          echo "ğŸ¤” Manual approval required for Terraform Plan"
          echo "ğŸ“‹ This will plan:"
          echo "   - VPC with public/private subnets"
          echo "   - NAT Gateway and Internet Gateway"
          echo "   - EKS Cluster (Kubernetes 1.31)"
          echo "   - 3 managed nodes (t3.medium, AL2023)"
          echo "   - EKS addons (CoreDNS, VPC-CNI, Kube-proxy, Pod Identity Agent)"
          echo "   - ElastiCache Redis cluster"
          echo "   - SIP Security Group (port 5060 from Twilio only)"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "â±ï¸ Time: ~3-5 minutes"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: GitHubActions-Terraform-Plan-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.3

      - name: Terraform Plan
        id: plan
        working-directory: resources
        run: |
          echo "ğŸ“‹ Running Terraform Plan..."
          
          terraform init -backend-config="../environments/livekit-poc/${{ env.AWS_REGION }}/${{ inputs.environment }}/backend.tfvars"
          
          terraform plan \
            -var-file="../environments/livekit-poc/${{ env.AWS_REGION }}/${{ inputs.environment }}/inputs.tfvars" \
            -var="deployment_role_arn=${{ secrets.DEPLOYMENT_ROLE_ARN }}" \
            -out=tfplan
          
          echo "âœ… Terraform plan completed successfully!"
          echo "ğŸ“Š Plan saved to tfplan file"
          
          # Show plan summary
          echo "ğŸ“‹ Plan Summary:"
          terraform show -no-color tfplan | head -50

  # Step 3: Terraform Apply
  terraform-apply:
    name: ğŸš€ Step 3 - Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    if: ${{ inputs.action == 'deploy' }}
    environment: livekit-poc-${{ inputs.environment }}-terraform-apply
    outputs:
      cluster-name: ${{ steps.apply.outputs.cluster_name }}
      redis-endpoint: ${{ steps.apply.outputs.redis_endpoint }}
    
    steps:
      - name: ğŸ“‹ Manual Approval - Terraform Apply
        run: |
          echo "ğŸ¤” Manual approval required for Terraform Apply"
          echo "âš ï¸  This will CREATE all infrastructure resources!"
          echo "ğŸ“‹ Resources to be created:"
          echo "   - VPC with subnets and gateways"
          echo "   - EKS Cluster with managed nodes"
          echo "   - ElastiCache Redis cluster"
          echo "   - Security groups and IAM roles"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "â±ï¸ Time: ~15-20 minutes"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: GitHubActions-Terraform-Apply-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.3

      - name: Terraform Apply
        id: apply
        working-directory: resources
        run: |
          echo "ğŸš€ Applying Terraform configuration..."
          
          terraform init -backend-config="../environments/livekit-poc/${{ env.AWS_REGION }}/${{ inputs.environment }}/backend.tfvars"
          
          echo "ğŸš€ Proceeding with Terraform apply..."
          
          echo "ğŸš€ Proceeding with clean Terraform apply..."
          
          terraform plan \
            -var-file="../environments/livekit-poc/${{ env.AWS_REGION }}/${{ inputs.environment }}/inputs.tfvars" \
            -var="deployment_role_arn=${{ secrets.DEPLOYMENT_ROLE_ARN }}" \
            -out=tfplan
          
          terraform apply tfplan
          
          # Get outputs
          CLUSTER_NAME=$(terraform output -raw cluster_name)
          REDIS_ENDPOINT=$(terraform output -raw redis_cluster_endpoint)
          
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "redis_endpoint=$REDIS_ENDPOINT" >> $GITHUB_OUTPUT
          
          echo "âœ… Infrastructure deployed successfully!"
          echo "ğŸ“Š Cluster: $CLUSTER_NAME"
          echo "ğŸ“Š Redis: $REDIS_ENDPOINT"

  # Step 4: Setup Load Balancer Controller
  setup-load-balancer:
    name: âš–ï¸ Step 4 - Setup Load Balancer Controller
    runs-on: ubuntu-latest
    needs: [terraform-apply]
    if: ${{ inputs.action == 'deploy' }}
    environment: livekit-poc-${{ inputs.environment }}-setup-load-balancer
    
    steps:
      - name: ğŸ“‹ Manual Approval - Setup Load Balancer
        run: |
          echo "ğŸ¤” Manual approval required to setup Load Balancer Controller"
          echo "ğŸ“‹ This will install:"
          echo "   - AWS Load Balancer Controller"
          echo "   - IAM service account with OIDC"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "â±ï¸ Time: ~3-5 minutes"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: GitHubActions-Setup-LB-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Tools
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq netcat-openbsd
          
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          
          # Install Helm
          curl -fsSL https://get.helm.sh/helm-v3.16.3-linux-amd64.tar.gz | tar -xz
          sudo mv linux-amd64/helm /usr/local/bin/
          
          # Install eksctl
          curl -sLO "https://github.com/eksctl-io/eksctl/releases/download/v0.191.0/eksctl_Linux_amd64.tar.gz"
          tar -xzf eksctl_Linux_amd64.tar.gz
          sudo mv eksctl /usr/local/bin/

      - name: Run Load Balancer Setup Script
        working-directory: scripts
        run: |
          chmod +x 02-setup-load-balancer.sh
          
          # Wait for cluster to be ready and verify status (optimized)
          echo "â³ Waiting for cluster to be ready..."
          echo "ğŸ“‹ Cluster: ${{ needs.terraform-apply.outputs.cluster-name }}"
          
          # Reduced initial wait for cluster stabilization
          sleep 30
          
          # Verify cluster is ACTIVE before proceeding (max 5 attempts with shorter intervals)
          echo "ğŸ” Verifying cluster status..."
          for i in {1..5}; do
            CLUSTER_STATUS=$(aws eks describe-cluster --name "${{ needs.terraform-apply.outputs.cluster-name }}" --region "${{ env.AWS_REGION }}" --query 'cluster.status' --output text 2>/dev/null || echo "UNKNOWN")
            echo "ğŸ“‹ Cluster status: $CLUSTER_STATUS (attempt $i/5)"
            
            if [ "$CLUSTER_STATUS" = "ACTIVE" ]; then
              echo "âœ… Cluster is ACTIVE and ready"
              break
            elif [ "$CLUSTER_STATUS" = "CREATING" ]; then
              echo "â³ Cluster still creating, waiting 20 seconds..."
              sleep 20
            else
              echo "âŒ Unexpected cluster status: $CLUSTER_STATUS"
              if [ $i -eq 5 ]; then
                echo "âŒ Cluster not ready after 5 attempts"
                echo "ğŸ’¡ Check AWS Console for cluster status"
                exit 1
              fi
            fi
          done
          
          # Run the script with optimized settings
          CLUSTER_NAME="${{ needs.terraform-apply.outputs.cluster-name }}" \
          AWS_REGION="${{ env.AWS_REGION }}" \
          ./02-setup-load-balancer.sh

  # Step 4.5: Test Load Balancer Controller (Optional)
  test-load-balancer:
    name: ğŸ§ª Step 4.5 - Test Load Balancer Controller
    runs-on: ubuntu-latest
    needs: [terraform-apply, setup-load-balancer]
    if: ${{ inputs.action == 'deploy' }}
    environment: livekit-poc-${{ inputs.environment }}-test-load-balancer
    continue-on-error: true  # Don't fail the pipeline if test fails
    
    steps:
      - name: ğŸ“‹ Manual Approval - Test Load Balancer
        run: |
          echo "ğŸ¤” Manual approval required to test Load Balancer Controller"
          echo "ğŸ“‹ This will test:"
          echo "   - Deploy test nginx application"
          echo "   - Create ALB ingress"
          echo "   - Verify ALB provisioning"
          echo "   - Clean up test resources"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "â±ï¸ Time: ~5-7 minutes"
          echo "â„¹ï¸  This step is optional and won't fail the pipeline"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: GitHubActions-Test-LB-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Tools
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

      - name: Run Load Balancer Test Script
        working-directory: scripts
        run: |
          chmod +x 03-test-load-balancer.sh
          
          # Run the test script
          CLUSTER_NAME="${{ needs.terraform-apply.outputs.cluster-name }}" \
          AWS_REGION="${{ env.AWS_REGION }}" \
          ./03-test-load-balancer.sh

  # Step 5: Deploy LiveKit
  deploy-livekit:
    name: ğŸ¥ Step 5 - Deploy LiveKit
    runs-on: ubuntu-latest
    needs: [terraform-apply, setup-load-balancer]
    if: ${{ inputs.action == 'deploy' }}
    environment: livekit-poc-${{ inputs.environment }}-deploy-livekit
    
    steps:
      - name: ğŸ“‹ Manual Approval - Deploy LiveKit
        run: |
          echo "ğŸ¤” Manual approval required to deploy LiveKit"
          echo "ğŸ“‹ This will deploy:"
          echo "   - LiveKit application via Helm"
          echo "   - Connected to Redis: ${{ needs.terraform-apply.outputs.redis-endpoint }}"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "â±ï¸ Time: ~5-10 minutes"
  
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: GitHubActions-Deploy-LiveKit-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
  
      - name: Setup Tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          curl -fsSL https://get.helm.sh/helm-v3.16.3-linux-amd64.tar.gz | tar -xz
          sudo mv linux-amd64/helm /usr/local/bin/
  
      - name: Run LiveKit Deployment Script
        working-directory: scripts
        run: |
          chmod +x 03-deploy-livekit.sh
          
          # Create environment configuration for the script
          cat > ../livekit.env << EOF
          # Pipeline Configuration - Auto-generated
          AWS_REGION=${{ env.AWS_REGION }}
          CLUSTER_NAME=${{ needs.terraform-apply.outputs.cluster-name }}
          
          # LiveKit API Credentials
          API_KEY=APIKmrHi78hxpbd
          SECRET_KEY=Y3vpZUiNQyC8DdQevWeIdzfMgmjs5hUycqJA22atniuB
          
          # Kubernetes Configuration
          NAMESPACE=livekit
          RELEASE_NAME=livekit
          
          # Autoscaling Configuration
          MIN_REPLICAS=1
          MAX_REPLICAS=20
          CPU_THRESHOLD=75
          
          # Resource Configuration
          CPU_REQUEST=500m
          CPU_LIMIT=2000m
          MEMORY_REQUEST=1Gi
          MEMORY_LIMIT=2Gi
          
          # LoadBalancer Configuration
          LB_TIMEOUT=600
          HEALTH_CHECK_TIMEOUT=300
          EOF
          
          echo "ğŸ“‹ Configuration created for environment: ${{ inputs.environment }}"
          echo "ğŸ“‹ Cluster: ${{ needs.terraform-apply.outputs.cluster-name }}"
          echo "ğŸ“‹ Redis: ${{ needs.terraform-apply.outputs.redis-endpoint }}"
          
          # Run the deployment script
          ./03-deploy-livekit.sh

  # DESTROY: Remove everything
  destroy:
    name: ğŸ—‘ï¸ Destroy LiveKit Infrastructure
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'destroy' }}
    environment: livekit-poc-${{ inputs.environment }}-destroy
    
    steps:
      - name: ğŸ“‹ Manual Approval - Destroy Everything
        run: |
          echo "ğŸ¤” Manual approval required for COMPLETE DESTRUCTION"
          echo "âš ï¸  DANGER: This will permanently delete ALL resources!"
          echo "ğŸ“‹ Resources to be destroyed:"
          echo "   - LiveKit application"
          echo "   - Load Balancer Controller"
          echo "   - Redis cluster"
          echo "   - EKS Cluster and VPC"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"
          echo "ğŸš¨ ALL DATA WILL BE PERMANENTLY LOST!"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: GitHubActions-LiveKit-Destroy-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Tools
        run: |
          wget -q https://releases.hashicorp.com/terraform/1.10.3/terraform_1.10.3_linux_amd64.zip
          unzip -q terraform_1.10.3_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          
          curl -LO "https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          
          curl -fsSL https://get.helm.sh/helm-v3.16.3-linux-amd64.tar.gz | tar -xz
          sudo mv linux-amd64/helm /usr/local/bin/

      - name: ğŸ—‘ï¸ Destroy All Infrastructure
        working-directory: resources
        run: |
          echo "ğŸ—‘ï¸ Destroying all infrastructure with Terraform..."
          
          terraform init -backend-config="../environments/livekit-poc/${{ env.AWS_REGION }}/${{ inputs.environment }}/backend.tfvars"
          
          # Run destroy with retries in case of transient errors
          MAX_ATTEMPTS=3
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "ğŸ”„ Destroy attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            if terraform destroy \
              -var-file="../environments/livekit-poc/${{ env.AWS_REGION }}/${{ inputs.environment }}/inputs.tfvars" \
              -var="deployment_role_arn=${{ secrets.DEPLOYMENT_ROLE_ARN }}" \
              -auto-approve; then
              echo "âœ… All infrastructure destroyed!"
              echo "ğŸ‰ DESTRUCTION COMPLETE!"
              exit 0
            else
              echo "âš ï¸ Destroy attempt $ATTEMPT failed"
              
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "âŒ Destroy failed after $MAX_ATTEMPTS attempts"
                echo "ğŸ” Checking for remaining resources..."
                terraform state list || true
                exit 1
              fi
              
              echo "â³ Waiting 10 seconds before retry..."
              sleep 10
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done